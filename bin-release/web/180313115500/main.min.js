var __reflect=this&&this.__reflect||function(t,e,i){t.__class__=e,i?i.push(e):i=[e],t.__types__=t.__types__?i.concat(t.__types__):i},__extends=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])};return function(e,i){function o(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(o.prototype=i.prototype,new o)}}(),Page=function(t){function e(){return t.call(this)||this}return __extends(e,t),e.prototype.createBitmap=function(t,e){void 0===e&&(e=!1);var i=new egret.Bitmap(RES.getRes(t));return e&&(i.anchorOffsetX=i.width/2,i.anchorOffsetY=i.height/2),i},e.prototype.createMovieClip=function(t,e){void 0===e&&(e=!0);var i=RES.getRes(t+"_json"),o=RES.getRes(t+"_png"),n=new egret.MovieClipDataFactory(i,o),s=new egret.MovieClip(n.generateMovieClipData(""+t));return e&&s.gotoAndPlay(0,-1),s},e.prototype.changePage=function(t){var e=this;if(null!=this.parent){var i=function(t){for(var e=0;e<t.numChildren;e++)egret.Tween.removeTweens(t.getChildAt(e)),null!=t.mask&&(t.mask.parent.removeChild(t.mask),t.mask=null),t instanceof egret.DisplayObjectContainer&&i(t.getChildAt(e)),t instanceof egret.MovieClip&&t.stop()};i(this),t.alpha=0,t.scaleX=t.scaleY=1.3,this.parent.addChild(t),egret.Tween.get(t).to({alpha:1,scaleX:1,scaleY:1},500,egret.Ease.cubicOut).call(function(){null!=e.parent&&e.parent.removeChild(e)},this)}},e}(egret.Sprite);__reflect(Page.prototype,"Page");var CreateMap=function(t){function e(){var e=t.call(this)||this;return e.spriteIndex=-1,log("创造"),e.addEventListener(egret.Event.ADDED_TO_STAGE,e.onAddToStage,e),e}return __extends(e,t),e.prototype.onAddToStage=function(){var t=this;log("创建完成按j");var e={"-1":"empty",0:"block",1:"BrickBlockBrown",2:"EmptyBlock",3:"QuestionBlock",4:"CoinForBlackBG"};this.drawGrid(),this.drawProp(e),this.mapData=[];for(var i=0;1125>i;i++)this.mapData.push(-1);window.addEventListener("keydown",function(e){"d"==e.key?t.map.x-=16:"a"==e.key?t.map.x+=16:"j"==e.key&&(t.changePage(new Map(t.mapData)),log(JSON.stringify(t.mapData)))}),this.map.touchEnabled=!0,this.addEventListener(egret.TouchEvent.TOUCH_BEGIN,function(t){},this),this.map.addEventListener(egret.TouchEvent.TOUCH_MOVE,function(i){var o=Math.floor(i.localX/16),n=Math.floor(i.localY/16);t.drawBlock(o,n,e),t.changeMapData(o,n)},this),this.map.addEventListener(egret.TouchEvent.TOUCH_END,function(t){},this),this.map.addEventListener(egret.TouchEvent.TOUCH_TAP,function(i){var o=Math.floor(i.localX/16),n=Math.floor(i.localY/16);t.drawBlock(o,n,e),t.changeMapData(o,n)},this)},e.prototype.changeMapData=function(t,e){var i=15*t+e;this.mapData[i]=this.spriteIndex},e.prototype.drawBlock=function(t,e,i){var o=15*t+e;if(-1==this.mapData[o]){var n,s=i[this.spriteIndex];n=this.spriteIndex<3?this.createBitmap(s):this.createMovieClip(s),n.x=16*t,n.y=16*e,this.map.addChild(n),log("draw")}},e.prototype.drawProp=function(t){var e=this,i=new egret.Sprite;i.y=250,this.addChild(i);for(var o=function(o){var s=t[o],r=void 0;r=3>o?n.createBitmap(s):n.createMovieClip(s),r.x=30+25*o,i.addChild(r),r.touchEnabled=!0,r.addEventListener(egret.TouchEvent.TOUCH_TAP,function(t){e.spriteIndex=o},n),log(s)},n=this,s=-1;s<Object.getOwnPropertyNames(t).length-1;s++)o(s)},e.prototype.drawGrid=function(){var t=2400;this.map=new egret.Sprite,this.map.width=t,this.map.height=240,this.addChild(this.map);var e=new egret.Shape;e.graphics.beginFill(16711935,.2),e.graphics.drawRect(0,0,2400,240),e.graphics.endFill(),this.map.addChild(e);for(var i=0;t/16>=i;i++){var o=16*i,n=this.drawLine(o,0,o,240);this.map.addChild(n)}for(var i=0;16>i;i++){var s=16*i,n=this.drawLine(0,s,t,s);this.map.addChild(n)}},e.prototype.drawLine=function(t,e,i,o){var n=new egret.Shape;return n.graphics.lineStyle(.1,0),n.graphics.moveTo(t,e),n.graphics.lineTo(i,o),n.graphics.endFill(),n},e}(Page);__reflect(CreateMap.prototype,"CreateMap");var level={1:[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,-1,-1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,-1,0,0,-1,-1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,-1,0,0,-1,0,-1,-1,-1,-1,-1,-1,3,-1,-1,-1,-1,0,0,-1,0,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,-1,0,0,-1,0,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,-1,0,0,-1,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,-1,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,-1,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,-1,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,-1,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,-1,0,0,-1,-1,-1,-1,-1,-1,4,-1,-1,-1,0,-1,-1,0,0,-1,-1,-1,-1,-1,4,4,-1,-1,-1,0,0,-1,0,0,-1,-1,-1,-1,4,4,-1,-1,-1,-1,0,0,-1,0,0,-1,-1,-1,-1,4,4,-1,-1,-1,-1,0,0,-1,-1,-1,-1,-1,-1,4,4,4,-1,-1,0,0,0,0,-1,-1,-1,-1,-1,-1,4,-1,-1,-1,-1,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,4,-1,0,0,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,0,0,0,0,0,-1,-1,-1,-1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,-1,-1,-1,0,-1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,-1,-1,-1,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,-1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,-1,-1,-1,0,-1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,-1,-1,-1,0,-1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,-1,-1,0,0,-1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,-1,-1,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,-1,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1]},Game=function(t){function e(){var e=t.call(this)||this;return e.jiansu=!1,e.setup(),e.addEventListener(egret.Event.ADDED_TO_STAGE,e.onAddToStageFunc,e),e}return __extends(e,t),e.prototype.setup=function(){var t=this;this.setUpInputs={keydowns:{},actions:{}},window.addEventListener("keydown",function(e){t.setUpInputs.keydowns[e.key]="down"}),window.addEventListener("keyup",function(e){t.setUpInputs.keydowns[e.key]="up"})},e.prototype.registerAction=function(t,e){this.setUpInputs.actions[t]=e},e.prototype.onAddToStageFunc=function(){var t=this,e=new Map(level[1]);this.tileMap=new egret.Sprite,this.tileMap.addChild(e),this.addChild(this.tileMap),this.mario=new Mario(level[1]),this.addChild(this.mario),this.mario.x=100,this.mario.y=208-this.mario.height/2,this.runLoopTimer(),this.registerAction("a",function(e){"down"==e?t.mario.speed>config.maxSpeedx/1.5&&1==config.direction?config.isBrake=!0:t.mario.move(-1):"up"==e&&(config.isInertia=!0),config.direction=-1}),this.registerAction("d",function(e){"down"==e?t.mario.speed>config.maxSpeedx/1.5&&-1==config.direction?config.isBrake=!0:t.mario.move(1):"up"==e&&(config.isInertia=!0),config.direction=1}),this.registerAction("k",function(){t.mario.jump()}),this.registerAction("h",function(){t.changePage(new CreateMap)})},e.prototype.runLoopTimer=function(){this.gameTimer=new egret.Timer(1e3/60,-1),this.gameTimer.addEventListener(egret.TimerEvent.TIMER,this.timerFunc,this),this.gameTimer.start()},e.prototype.timerFunc=function(){for(var t=Object.keys(this.setUpInputs.actions),e=0;e<t.length;e++){var i=t[e],o=this.setUpInputs.keydowns[i];"down"==o?(this.setUpInputs.actions[i]("down"),this.jiansu=!1):"up"==o&&(this.setUpInputs.actions[i]("up"),this.setUpInputs.keydowns[i]=null)}this.mario.update(),this.mario.x>=110&&(this.mario.x=110,this.tileMap.x-=this.mario.speed,config.tileMapX=this.tileMap.x)},e}(Page);__reflect(Game.prototype,"Game");var LoadingUI=function(t){function e(){var e=t.call(this)||this;return e.createView(),e}return __extends(e,t),e.prototype.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},e.prototype.setProgress=function(t,e){this.textField.text="Loading..."+t+"/"+e},e}(egret.Sprite);__reflect(LoadingUI.prototype,"LoadingUI");var Main=function(t){function e(){var e=t.call(this)||this;return e.addEventListener(egret.Event.ADDED_TO_STAGE,e.onAddToStage,e),e}return __extends(e,t),e.prototype.onAddToStage=function(t){var e=this;log=console.log.bind(console),W=this.stage.stageWidth,H=this.stage.stageHeight;var i=new XMLHttpRequest;i.open("GET","./resource/default.res.json",!0),i.onreadystatechange=function(){if(4==i.readyState&&200==i.status){var t=JSON.parse(i.responseText);e.onConfigComplete(t)}},i.send(null)},e.prototype.onConfigComplete=function(t){var e=function(){var e={groups:[{keys:"",name:"preload"}],resources:[]};e.resources=t.resources;for(var i in e.resources)e.groups[0].keys+=e.resources[i].name+",";return e}();RES.parseConfig(e,"./resource/"),this.loadingView=new LoadingUI,this.stage.addChild(this.loadingView),RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),RES.loadGroup("preload")},e.prototype.onResourceLoadComplete=function(t){"preload"==t.groupName&&(this.stage.removeChild(this.loadingView),RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.removeEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),this.createGameScene())},e.prototype.onItemLoadError=function(t){console.warn("Url:"+t.resItem.url+" has failed to load")},e.prototype.onResourceLoadError=function(t){console.warn("Group:"+t.groupName+" has failed to load"),this.onResourceLoadComplete(t)},e.prototype.onResourceProgress=function(t){"preload"==t.groupName&&this.loadingView.setProgress(t.itemsLoaded,t.itemsTotal)},e.prototype.createGameScene=function(){this.addChild(new Game)},e}(egret.DisplayObjectContainer);__reflect(Main.prototype,"Main");var Map=function(t){function e(e){var i=t.call(this)||this;return i.map=e,i.addEventListener(egret.Event.ADDED_TO_STAGE,i.onAddToStageFunc,i),i}return __extends(e,t),e.prototype.onAddToStageFunc=function(){for(var t=16,e={0:"block",1:"BrickBlockBrown",2:"EmptyBlock",3:"QuestionBlock",4:"CoinForBlackBG"},i=0;i<this.map.length;i++){var o=this.map[i],n=void 0;-1!=o&&(3>o?(n=this.createBitmap(""+e[o]),this.addChild(n)):(n=this.createMovieClip(""+e[o]),this.addChild(n)),n.x=Math.floor(i/15)*t,n.y=i%15*t)}},e}(Page);__reflect(Map.prototype,"Map");var config={g:.1,gy:0,vy:0,ax:.2,maxSpeedx:3.5,jumpvy:6,jumpHeight:5.5,isInertia:!1,isBrake:!1,direction:1,tileMapX:0},Mario=function(t){function e(e){var i=t.call(this)||this;return i.scaleNumber=1,i.g=1,i.map=e,i.init(),i}return __extends(e,t),e.prototype.init=function(){this.mario=this.createBitmap("sprite.MarioStanding"),this.addChild(this.mario),log(this.height),this.setup()},e.prototype.setup=function(){this.speed=0,this.scaleX=this.scaleY=this.scaleNumber,this.anchorOffsetX=this.mario.width/2,this.anchorOffsetY=this.mario.height/2,this.status="stand",this.tilePosition=this.getBlockPosition()},e.prototype.stand=function(){this.speed=0,this.status="stand",this.mario&&this.removeChild(this.mario),this.mario=this.createBitmap("sprite.MarioStanding"),this.addChild(this.mario)},e.prototype.run=function(){"run"!=this.status&&this.mario&&(this.removeChild(this.mario),this.status="run",this.mario=this.createMovieClip("smallMario"),this.addChild(this.mario))},e.prototype.skidding=function(t){"run"==this.status&&this.mario&&(this.removeChild(this.mario),this.status="skidding",this.mario=this.createBitmap("sprite.MarioSkidding"),this.addChild(this.mario)),this.speed-=config.ax,this.x+=this.speed*t,this.speed<=0&&(this.speed=0,config.isBrake=!1,this.stand())},e.prototype.flipX=function(t){this.scaleX=t},e.prototype.addSpeed=function(){this.speed+=config.ax,this.speed>=config.maxSpeedx&&(this.speed=config.maxSpeedx)},e.prototype.inertia=function(t){this.run(),this.speed-=config.ax,this.x+=this.speed*t,this.speed<=0&&(this.speed=0,config.isInertia=!1,this.stand())},e.prototype.move=function(t){this.run(),this.addSpeed(),this.flipX(this.scaleNumber*t),this.x+=this.speed*t},e.prototype.jump=function(){this.status="jump",config.jumpvy-=config.g,this.y-=config.jumpvy,this.mario&&this.removeChild(this.mario),this.mario=this.createBitmap("sprite.MarioJumping"),this.addChild(this.mario)},e.prototype.fallDown=function(){config.gy+=config.g,this.y+=config.gy,this.top=this.y-this.height/2,this.down=this.y+this.height/2,this.left=this.x-this.width/2,this.right=this.x+this.width/2,this.onTheGround(this.x,this.y)},e.prototype.onTheGround=function(t,e){for(var i=0;i<this.tilePosition.length;i++){var o=this.tilePosition[i];o.x+config.tileMapX>0&&o.x+config.tileMapX<240&&this.down>=o.y&&this.top<=o.y+16&&this.right>o.x+config.tileMapX&&this.left<o.x+config.tileMapX+16&&(this.y=o.y-this.height/2,config.gy=0,config.jumpvy=config.jumpHeight)}},e.prototype.getBlockPosition=function(){for(var t=[],e=0;e<this.map.length;e++){var i=this.map[e],o={index:i,x:0,y:0};i>-1&&(o.x=16*Math.floor(e/15),o.y=e%15*16,t.push(o))}return t},e.prototype.update=function(){config.isInertia&&this.inertia(config.direction),config.isBrake&&this.skidding(config.direction),this.fallDown()},e}(Page);__reflect(Mario.prototype,"Mario");